# 🚀 重启服务指南

> ⚠️ **重要提示**: 本次更新为 V3.4.1 - 未测试版本  
> 所有Bug修复已在代码中完成，但尚未经过实际运行验证。请仔细按照本指南测试。

## 快速重启

### Windows PowerShell（推荐）

```powershell
# 方式1: 使用启动脚本（最简单）
.\start_all.ps1

# 方式2: 分别启动
.\start_backend.ps1  # 终端1
.\start_frontend.ps1 # 终端2
```

---

## 重启原因

本次需要重启以应用以下重要更新：

### 后端更新（需要重启后端）
- ✅ Agent超时配置（300迭代+240秒）
- ✅ Prompt偏远景点禁止清单
- ✅ 时间自动分配逻辑
- ✅ 迭代系数优化

### 前端更新（需要刷新页面）
- ✅ 地图路径提取逻辑
- ✅ 地图视野控制
- ✅ SVG编码修复
- ✅ 统计浮层优化
- ✅ 错误处理完善

---

## 详细步骤

### 1. 停止当前服务

如果服务正在运行，按 `Ctrl+C` 停止：

```powershell
# 在运行后端的终端按 Ctrl+C
# 在运行前端的终端按 Ctrl+C
```

### 2. 重启后端

```powershell
cd C:\Users\ViVi141\Desktop\design
.\start_backend.ps1
```

**等待看到**：
```
INFO: Uvicorn running on http://127.0.0.1:8000
INFO: Application startup complete.
```

### 3. 重启前端

```powershell
# 在另一个终端
cd C:\Users\ViVi141\Desktop\design
.\start_frontend.ps1
```

**等待看到**：
```
VITE ready in XXXms
➜  Local:   http://localhost:3000/
```

### 4. 刷新浏览器

打开浏览器访问：
```
http://localhost:3000/ultimate-planner
```

按 `Ctrl+Shift+R` 强制刷新（清除缓存）

---

## ✅ 验证清单

### 后端验证
- [ ] 控制台显示 `[Agent] 设置max_iterations: 300`（或接近值）
- [ ] 控制台显示 `[Agent] 超时时间: 240.0秒`
- [ ] Agent日志正常输出

### 前端验证
- [ ] 地图正常加载
- [ ] 可以在地图任意位置拖动（不是只有标记上）
- [ ] 鼠标滚轮可以缩放
- [ ] 统计浮层紧凑（不覆盖整个地图）

### 功能验证
- [ ] 生成一个新行程
- [ ] Agent不超时（<180秒完成）
- [ ] 没有偏远景点（友谊葫芦、万德等）
- [ ] 景点都在核心市区
- [ ] 景点时间不同（09:00, 13:30, 19:30）
- [ ] 地图稳定不跳转
- [ ] 路线正常绘制（不全是直线）
- [ ] 控制台无大量错误

---

## 🐛 常见问题

### Q1: 后端启动失败
**错误**: `ModuleNotFoundError`
**解决**: 
```powershell
cd backend
pip install -r requirements.txt
```

### Q2: 前端启动失败
**错误**: `command not found: pnpm`
**解决**:
```powershell
npm install -g pnpm
cd frontend
pnpm install
```

### Q3: 端口被占用
**错误**: `Address already in use`
**解决**:
```powershell
# 后端（8000端口）
netstat -ano | findstr :8000
taskkill /PID <PID> /F

# 前端（3000端口）
netstat -ano | findstr :3000
taskkill /PID <PID> /F
```

### Q4: 修改未生效
**解决**:
1. 确认文件已保存
2. 重启服务
3. 浏览器强制刷新（Ctrl+Shift+R）
4. 清除浏览器缓存

---

## 📊 测试建议

### 推荐测试顺序

#### 测试1: 验证地图修复
1. 访问规划页面
2. 不生成行程，直接测试地图拖动
3. 验证地图可以在任意位置拖动

#### 测试2: 验证Agent规划
1. 填写：济南、淄博、青岛，7天，3000元
2. 选择出发日期：本周六
3. 点击生成
4. 观察控制台：工具调用次数、是否超时
5. 检查景点：是否都在市区核心

#### 测试3: 验证地图显示
1. 行程生成后，观察地图
2. 统计浮层是否紧凑
3. 路线是否正常绘制
4. 地图是否稳定（不跳转）
5. 酒店图标是否正常

---

## 📝 测试记录模板

```
【测试时间】: ____
【测试用例】: ____

Agent执行:
- 完成时间: __秒
- 工具调用: __次
- 是否超时: 是/否

景点规划:
- 城市顺序: ____
- 景点分布: 核心市区/有偏远
- 偏远景点: 有/无（列举）
- 时间分配: 正确/都是09:00

地图显示:
- 可拖动: 是/否
- 可缩放: 是/否
- 视野稳定: 是/否
- 路线绘制: 正常/直线/错误
- 统计浮层: 正常/巨大

控制台:
- 错误数量: __个
- 主要错误: ____

总体评价: ⭐⭐⭐⭐⭐
```

---

## 🎯 下一步

1. **立即重启服务**
2. **按测试清单验证**
3. **记录测试结果**
4. **反馈任何问题**

如果发现新问题，请提供：
- 完整的控制台日志
- 具体的测试参数
- 截图（如果UI相关）

---

**准备就绪！请重启服务并测试！** 🚀

---

## ⚠️ 未测试版本说明

**V3.4.1 是未经测试的版本**，包含以下修复：

### 已完成的修复（理论上）
1. ✅ Agent超时问题（max_iterations=300）
2. ✅ 偏远景点问题（Prompt禁止清单）
3. ✅ 地图拖动问题（dragEnable配置）
4. ✅ 路径绘制问题（steps提取逻辑）
5. ✅ SVG编码问题（encodeURIComponent）
6. ✅ 统计浮层问题（尺寸限制）

### 可能的风险
- ⚠️ Agent可能仍然超时（取决于网络和API响应）
- ⚠️ 某些边缘情况可能未覆盖
- ⚠️ 新修复可能引入新问题

### 测试建议
1. 先用简单场景测试（北京3天）
2. 观察控制台错误
3. 记录详细问题
4. 逐步测试复杂场景

如发现任何问题，请提供：
- 完整的控制台日志
- 测试参数
- 问题截图
- 问题复现步骤

